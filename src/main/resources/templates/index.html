<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Home - ChatFlow</title>
    <link href="/css/app.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        // Toggle dropdown for profile menu
        function toggleDropdown() {
            document.getElementById('profileDropdown').classList.toggle('hidden');
        }

        // Close dropdown when clicking outside
        window.addEventListener('click', function(e) {
            if (!e.target.closest('#profileMenu')) {
                document.getElementById('profileDropdown').classList.add('hidden');
            }
        });

        // Load chat for selected friend or agent
        function openChat(name) {
            document.getElementById('chatWith').innerText = name;
            document.getElementById('chatMessages').innerHTML = '';

            fetch(`/chat/history?recipient=${name}`)
                .then(res => res.json())
                .then(messages => {
                    if (messages.length === 0) {
                        let msg = document.createElement('p');
                        msg.className = 'text-gray-500';
                        msg.innerText = `No previous messages with ${name}.`;
                        document.getElementById('chatMessages').appendChild(msg);
                    } else {
                        messages.forEach(m => {
                            let msg = document.createElement('div');
                            if (m.startsWith("You:")) {
                                msg.className = 'self-end bg-blue-500 text-white px-4 py-2 rounded-2xl max-w-xs text-sm mb-2';
                                msg.innerText = m.replace("You:", "").trim();
                            } else {
                                msg.className = 'self-start bg-gray-200 text-gray-800 px-4 py-2 rounded-2xl max-w-xs text-sm mb-2';
                                msg.innerText = m;
                            }
                            document.getElementById('chatMessages').appendChild(msg);
                        });
                    }
                });
        }

        // Send a message
        function sendMessage() {
            const recipient = document.getElementById('chatWith').innerText;
            const input = document.querySelector('input[type=text]');
            const message = input.value.trim();

            if (!recipient || recipient === "...") {
                alert("Select someone to chat with first!");
                return;
            }
            if (!message) return;

            fetch(`/chat/send?recipient=${recipient}&message=${encodeURIComponent(message)}`, {
                method: 'POST'
            }).then(() => {
                const placeholder = document.querySelector('#chatMessages p.text-gray-500');
                if (placeholder) placeholder.remove();

                let msg = document.createElement('div');
                msg.className = 'self-end bg-blue-500 text-white px-4 py-2 rounded-2xl max-w-xs text-sm mb-2';
                msg.innerText = message;
                document.getElementById('chatMessages').appendChild(msg);
                input.value = "";
            });
        }

        // Autocomplete: search users while typing

        // default delay of 200 ms before calling suggest again
        function debounce(fn, d = 200) {
            let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), d); };
        }

        // prevent hacks
        function esc(s){
            return s.replace(/[&<>"']/g, c => ({
                "&": "&amp;",
                "<": "&lt;",
                ">": "&gt;",      
                "\"": "&quot;",
                "'": "&#39;"
            }[c]));
        }

        // init after DOM ready
        window.addEventListener("DOMContentLoaded", () => {
            const input = document.getElementById("friendSearch");
            const resultsBox = document.getElementById("searchResults");
            let activeIndex = -1;
            let suggestions = [];

            async function fetchNames(q){
                const resp = await fetch(`/users/suggest?q=${encodeURIComponent(q)}`, { credentials: "include" });
                if (!resp.ok) return [];
                return resp.json();
            }

            function render(items){
                suggestions = items; activeIndex = -1;
                if (!items.length){
                resultsBox.innerHTML = "<div class='px-2 py-1 text-gray-500'>No matches</div>";
                resultsBox.classList.remove("hidden");
                return;
                }
                resultsBox.innerHTML = items.map((u,i)=>`
                <div class="px-2 py-1 hover:bg-gray-100 cursor-pointer"
                    role="option" id="sr-${i}"
                    onclick="selectUser('${esc(u)}')">${esc(u)}</div>
                `).join("");
                resultsBox.classList.remove("hidden");
            }

            const doSearch = debounce(async (val)=>{
                const q = (val||"").trim();
                if (q.length < 2){ resultsBox.innerHTML = ""; resultsBox.classList.add("hidden"); return; }
                try { render(await fetchNames(q)); }
                catch { resultsBox.innerHTML = ""; resultsBox.classList.add("hidden"); }
            }, 200);

            // called by oninput="searchUsers(this.value)"
            window.searchUsers = (v)=>doSearch(v);

            window.selectUser = (u)=>{
                input.value = u;
                resultsBox.classList.add("hidden");
                resultsBox.innerHTML = "";
            };

            document.addEventListener("click",(e)=>{
                if (!resultsBox.contains(e.target) && e.target !== input){
                resultsBox.classList.add("hidden");
                }
            });

            input.addEventListener("keydown",(e)=>{
                if (resultsBox.classList.contains("hidden") || suggestions.length === 0) return;
                if (e.key==="ArrowDown"){ e.preventDefault(); activeIndex=(activeIndex+1)%suggestions.length; updateActive(); }
                else if (e.key==="ArrowUp"){ e.preventDefault(); activeIndex=(activeIndex-1+suggestions.length)%suggestions.length; updateActive(); }
                else if (e.key==="Enter" && activeIndex>=0){ e.preventDefault(); window.selectUser(suggestions[activeIndex]); }
                else if (e.key==="Escape"){ resultsBox.classList.add("hidden"); }
            });

            function updateActive(){
                [...resultsBox.children].forEach((el,i)=>el.classList.toggle("bg-gray-100", i===activeIndex));
            }

        });

        // Add friend
        function addFriendFromInput() {
            const username = document.getElementById("friendSearch").value.trim();
            if (!username) return;
            fetch(`/friends/add?username=${encodeURIComponent(username)}`, { method: "POST" })
              .then(res => res.text())
              .then(msg => {
                  alert(msg);
                  document.getElementById("friendSearch").value = "";
                  document.getElementById("searchResults").classList.add("hidden");
                  loadFriends();
              });
        }

        // Load friends
        function loadFriends() {
            fetch("/friends")
              .then(res => res.json())
              .then(friends => {
                  const list = document.getElementById("userList");
                  list.innerHTML = "";
                  if (friends.length === 0) {
                      list.innerHTML = `<p class="text-gray-500">You have no friends yet.</p>`;
                  } else {
                      friends.forEach(u => {
                          let li = document.createElement("li");
                          li.innerHTML = `
                              <button onclick="openChat('${u}')"
                                      class="w-full text-left px-3 py-2 rounded hover:bg-gray-100">
                                  ${u}
                              </button>`;
                          list.appendChild(li);
                      });
                  }
              });
        }



        window.addEventListener("DOMContentLoaded", loadFriends);
    </script>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="bg-white shadow-md px-6 py-3 flex justify-between items-center">
        <div class="text-2xl font-bold text-blue-600">ChatFlow</div>

        <div class="relative" id="profileMenu">
            <button onclick="toggleDropdown()">
                <img th:if="${avatarUrl != null}"
                    th:src="${avatarUrl}"
                    alt="avatar"
                    class="w-8 h-8 rounded-full object-cover border" />
                <div th:if="${avatarUrl == null}"
                    class="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold">
                    <span th:text="${#strings.isEmpty(username) ? 'U' : #strings.substring(username,0,1)}">U</span>
                </div>
            </button>

            <div id="profileDropdown"
                 class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg py-2 z-10">
                <p class="px-4 py-2 text-gray-700 font-semibold"
                   th:text="${#strings.isEmpty(username) ? 'Unknown User' : username}">
                    Username
                </p>
                <a href="/profilepicture" class="block px-4 py-2 text-gray-600 hover:bg-gray-100">Change Profile Picture</a>
                <a href="/settings" class="block px-4 py-2 text-gray-600 hover:bg-gray-100">Settings</a>
                <form th:action="@{/logout}" method="post" class="mt-2 border-t">
                    <input type="hidden" name="_csrf" th:value="${_csrf.token}" />
                    <button type="submit"
                            class="w-full text-left px-4 py-2 text-red-600 hover:bg-gray-100">
                        Log out
                    </button>
                </form>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="flex flex-1 overflow-hidden">

        <!-- Sidebar (using aside key word) -->
        <aside class="w-64 bg-white shadow-inner p-4 overflow-y-auto">
        <h2 class="text-xl font-semibold mb-4 text-blue-600">Friends</h2>

        <!-- Search row -->
        <div class="mb-2 flex items-center gap-2">
            <div class="flex-1">
            <input type="text" id="friendSearch" placeholder="Enter username"
                    class="border px-2 py-1 rounded w-full"
                    oninput="searchUsers(this.value)">
            </div>
            <button onclick="addFriendFromInput()"
                    class="bg-green-500 text-white px-3 py-1 rounded">
            Add
            </button>
        </div>

        <!-- Popup with Suggestions -->
        <div id="searchResults"
            class="bg-white border rounded w-full mb-6 hidden max-h-56 overflow-y-auto shadow"></div>

        <!-- Friends list -->
        <ul id="userList"></ul>

        <!-- AI Agents -->
        <h2 class="text-xl font-semibold mb-4 text-blue-600 mt-5">AI Agents</h2>
        <ul>
            <li class="mb-2">
            <button onclick="openChat('Grok')"
                    class="w-full text-left px-3 py-2 rounded hover:bg-gray-100">
                Grok
            </button>
            </li>
        </ul>
        </aside>

        <!-- Chat area -->
        <main class="flex-1 p-6 flex flex-col bg-gray-50 overflow-hidden">
            <div class="flex-1 overflow-y-auto mb-4">
                <h2 class="text-xl font-semibold mb-4 text-blue-600">Chat with <span id="chatWith">...</span></h2>
                <div id="chatMessages" class="space-y-2 flex flex-col">
                    <p class="text-gray-500">Select a friend or AI agent to start chatting.</p>
                </div>
            </div>
            <div class="flex mt-auto">
                <input type="text" placeholder="Type your message..."
                       class="flex-1 px-4 py-2 rounded-l-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"/>
                <button onclick="sendMessage()" 
                        class="bg-blue-500 text-white px-4 py-2 rounded-r-lg hover:bg-blue-600">
                    Send
                </button>
            </div>
        </main>
    </div>
    
</body>
</html>
